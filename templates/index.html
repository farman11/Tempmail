{% extends "base.html" %}

{% block content %}
<!-- Dark Header Section with Email Display -->
<div class="bg-gray-800 text-white py-8 md:py-16">
    <div class="max-w-4xl mx-auto text-center px-4 sm:px-6">
        <h1 class="text-2xl sm:text-3xl font-bold mb-6 md:mb-8">
            Your Temporary Email Address
        </h1>
        
        {% if active_emails and active_emails|length > 0 %}
        <!-- Display existing email -->
        <div class="bg-gray-700 rounded-lg p-4 sm:p-6 mb-4 md:mb-6 max-w-2xl mx-auto">
            <div class="flex flex-col sm:flex-row items-center justify-center sm:space-x-4 space-y-3 sm:space-y-0">
                <code class="text-lg sm:text-xl font-mono text-white email-address-display overflow-text">{{ active_emails[0].email_address }}</code>
                <div class="flex space-x-2">
                    <button class="bg-gray-600 hover:bg-blue-500 text-white p-2 rounded copy-btn transition-all duration-200 hover:scale-110" 
                            data-text="{{ active_emails[0].email_address }}" title="Copy Email">
                        <i class="fas fa-copy"></i>
                    </button>
                    
                    <button class="bg-gray-600 hover:bg-green-500 text-white p-2 rounded transition-all duration-200 hover:scale-110" 
                        onclick="refreshEmails()" title="Refresh Emails">
                         <i class="fas fa-sync-alt"></i>
                    </button>
                   
                </div>
            </div>
        </div>
        {% else %}
        <!-- Generate new email -->
        <div class="bg-gray-700 rounded-lg p-4 sm:p-6 mb-4 md:mb-6 max-w-2xl mx-auto">
            <form method="POST" action="{{ url_for('generate_email') }}" class="text-center">
                <p class="text-gray-300 mb-4 text-sm sm:text-base">Click to generate your temporary email address</p>
                <button type="submit" class="bg-green-600 hover:bg-green-500 text-white font-semibold py-3 px-6 sm:px-8 rounded-lg btn-transition w-full sm:w-auto">
                    Generate Email Address
                </button>
            </form>
        </div>
        {% endif %}
        
        <p class="text-gray-300 text-xs sm:text-sm max-w-2xl mx-auto px-2">
            Forget about spam, advertising mailings, hacking and attacking robots. Keep your 
            real mailbox clean and secure. Temp Mail provides temporary, secure, anonymous, 
            free, disposable email address.
        </p>
    </div>
</div>

<!-- Action Buttons Section -->
{% if active_emails and active_emails|length > 0 %}
<div class="bg-white border-b border-gray-200 py-3 md:py-4">
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
        <div class="flex justify-center space-x-3 sm:space-x-6 action-buttons">
            <button class="flex items-center space-x-1 sm:space-x-2 text-gray-700 hover:text-blue-600 hover:bg-blue-50 px-2 py-1 rounded transition-all duration-200 copy-btn text-sm sm:text-base" 
                    data-text="{{ active_emails[0].email_address }}">
                <i class="fas fa-copy"></i>
                <span class="hidden sm:inline">Copy</span>
            </button>

            <button class="flex items-center space-x-1 sm:space-x-2 text-gray-700 hover:text-green-600 hover:bg-green-50 px-2 py-1 rounded transition-all duration-200 text-sm sm:text-base" onclick="refreshEmails()">
                <i class="fas fa-sync-alt"></i>
                <span class="hidden sm:inline">Refresh</span>
            </button>
            
            <button class="flex items-center space-x-1 sm:space-x-2 text-gray-700 hover:text-purple-600 hover:bg-purple-50 px-2 py-1 rounded transition-all duration-200 text-sm sm:text-base" onclick="changeEmail()">
                <i class="fas fa-edit"></i>
                <span class="hidden sm:inline">Change</span>
            </button>

        </div>
    </div>
</div>
{% endif %}

<!-- Main Content Area with Sidebar -->
<div class="flex flex-col lg:flex-row max-w-7xl mx-auto">
    <!-- Main Content -->
    <div class="flex-1 bg-white">
        <!-- Email Inbox Section -->
        {% if active_emails and active_emails|length > 0 %}
        <div class="p-3 sm:p-4 lg:p-6">
            <!-- Inbox Header -->
            <div class="bg-gray-800 text-white px-2 sm:px-4 py-3 flex justify-between items-center text-sm sm:text-base">
                <span class="font-semibold flex-1">SENDER</span>
                <span class="font-semibold flex-1 hidden sm:block">SUBJECT</span>
                <span class="font-semibold">VIEW</span>
            </div>
            
            <!-- Email List -->
            {% if active_emails[0].messages and active_emails[0].messages|length > 0 %}
                {% for message in active_emails[0].messages %}
                <div class="border-b border-gray-200 px-2 sm:px-4 py-3 sm:py-4 hover:bg-gray-50">
                    <div class="flex justify-between items-start sm:items-center mb-2">
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-900 text-sm sm:text-base truncate overflow-text">
                                {% if message.sender_name and message.sender_name != message.sender_email %}
                                    {{ message.sender_name }}
                                {% elif message.sender_email %}
                                    {{ message.sender_email.split('@')[0] }}
                                {% else %}
                                    {{ message.sender.split('@')[0] if message.sender else 'Unknown' }}
                                {% endif %}
                            </div>
                            <div class="text-xs sm:text-sm text-gray-500 truncate overflow-text">{{ message.sender_email or message.sender or 'Unknown' }}</div>
                            <div class="block sm:hidden text-sm text-gray-900 mt-1 overflow-text">{{ message.subject }}</div>
                        </div>
                        <div class="flex-1 px-2 sm:px-4 hidden sm:block min-w-0">
                            <div class="font-medium text-gray-900 text-sm sm:text-base truncate overflow-text">{{ message.subject }}</div>
                        </div>
                        <div class="ml-2">
                            <button class="text-blue-600 hover:text-blue-800 toggle-email p-2" data-message-id="{{ loop.index }}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Email Content (Initially Hidden) - Gmail Style -->
                    <div id="email-content-{{ loop.index }}" class="hidden mt-4 bg-white rounded-lg shadow-sm border border-gray-200" style="display: none;">
                        <!-- Gmail-style Header -->
                        <div class="p-4 border-b border-gray-100 bg-gray-50 rounded-t-lg">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-1">{{ message.subject or 'No Subject' }}</h3>
                                    <div class="text-sm text-gray-600">
                                        <div class="mb-1">
                                            <span class="font-medium">{{ message.sender_name or (message.sender_email.split('@')[0] if message.sender_email else 'Unknown') }}</span>
                                            <span class="text-gray-500 ml-1">&lt;{{ message.sender_email or message.sender or 'unknown@example.com' }}&gt;</span>
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            to {{ active_emails[0].email_address }}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 ml-4">
                                    {{ message.received_at.strftime('%b %d, %Y at %H:%M') if message.received_at else 'Unknown date' }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gmail-style Email Body -->
                        <div class="p-6">
                            {% if message.html_content and message.html_content|string and message.html_content|string|trim %}
                                <div class="gmail-email-content">
                                    {{ message.html_content|safe }}
                                </div>
                            {% elif message.text_content and message.text_content|string and message.text_content|string|trim %}
                                <div class="gmail-email-content text-content">
                                    {{ message.text_content|replace('\n', '<br>')|safe }}
                                </div>
                            {% elif message.body and message.body|string and message.body|string|trim %}
                                <div class="gmail-email-content text-content">
                                    {{ message.body|replace('\n', '<br>')|safe }}
                                </div>
                            {% else %}
                                <div class="text-gray-500 italic text-center py-8">
                                    <i class="fas fa-envelope-open text-2xl mb-2"></i>
                                    <p>No message content available</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="text-center py-12 text-gray-500">
                <i class="fas fa-inbox text-4xl mb-4"></i>
                <p>No emails received yet</p>
                <p class="text-sm">Emails will appear here automatically</p>
                <button onclick="refreshEmails()" class="mt-6 text-gray-600 hover:text-gray-800 p-6 rounded-full refresh-emails-btn" title="Refresh Emails">
                    <i class="fas fa-sync-alt text-3xl refresh-icon-infinite"></i>
                </button>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- What is Disposable Temporary Email Section -->
        <div class="p-3 sm:p-4 lg:p-6">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 sm:mb-6">What is Disposable Temporary E-mail?</h2>
            <div class="text-gray-700 space-y-3 sm:space-y-4 text-sm sm:text-base">
                <p class="overflow-text">
                    Disposable email - is a free email service that allows to receive email at a temporary address 
                    that self-destructed after a certain time elapses. It is also known by names like: tempmail, 
                    10minutemail, throwaway email, fake-mail or trash-mail. Many forums, Wi-Fi owners, websites and 
                    blogs ask visitors to register before they can view content, post comments or download something. 
                    Temp-Mail - is most advanced throwaway email service that helps you avoid spam and stay safe.
                </p>
            </div>
            
            <!-- Ad Banner (Mobile responsive) -->
            <div class="my-6 sm:my-8">
                <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg p-3 sm:p-4 text-white text-center">
                    <small class="block mb-2 opacity-75 text-xs sm:text-sm">Advertisement</small>
                    <div class="text-xs sm:text-sm">
                        <i class="fas fa-ad text-xl sm:text-2xl mb-2"></i>
                        <p class="overflow-text">Make it with Creative Cloud. Apps for photography, design, video, and web from $59.99/mo</p>
                    </div>
                </div>
            </div>
            
            <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-3 sm:mb-4">Popular Articles</h3>
        </div>
    </div>
    
    <!-- Right Sidebar (Hidden on mobile and tablet) -->
    <div class="hidden lg:block w-80 bg-white border-l border-gray-200">
        <!-- Advertisement Space -->
        <div class="p-4">
            <div class="bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg p-6 text-white text-center min-h-80">
                <small class="block mb-2 opacity-75">Advertisement</small>
                <div class="text-center">
                    <i class="fas fa-ad text-3xl mb-3"></i>
                    <h3 class="text-lg font-bold mb-2">Make it with Creative Cloud</h3>
                    <p class="text-sm mb-4">Apps for photography, design, video, and web from $59.99/mo</p>
                    <button class="bg-white text-purple-600 px-4 py-2 rounded font-semibold">
                        Join now
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Real-time email refresh functionality
function refreshEmails() {
    const refreshIcons = document.querySelectorAll('.fa-sync-alt, .refresh-icon-infinite');
    
    // Add spinning animation to all refresh icons
    refreshIcons.forEach(icon => {
        icon.classList.add('refresh-spinning');
    });
    
    // Get email ID from active email if available
    {% if active_emails and active_emails|length > 0 %}
    const emailId = '{{ active_emails[0].id }}';
    
    // Call the fetch-emails endpoint with email ID
    fetch('/fetch-emails/' + emailId, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Current messages:', data.count, 'New count:', data.count);
        if (data.status === 'success') {
            // Always reload to show updated message count/content
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    })
    .finally(() => {
        // Remove spinning animation
        refreshIcons.forEach(icon => {
            icon.classList.remove('refresh-spinning');
        });
    });
    {% else %}
    // No email available, just remove animation
    setTimeout(() => {
        refreshIcons.forEach(icon => {
            icon.classList.remove('refresh-spinning');
        });
    }, 1000);
    {% endif %}
}

// Automatic refresh functionality
function startAutoRefresh() {
    {% if active_emails and active_emails|length > 0 %}
    const emailId = '{{ active_emails[0].id }}';
    console.log('Setting up auto-refresh for email ID:', emailId);
    
    // Auto-refresh every 15 seconds
    setInterval(() => {
        const refreshIcons = document.querySelectorAll('.fa-sync-alt, .refresh-icon-infinite');
        
        // Add subtle auto-refresh animation
        refreshIcons.forEach(icon => {
            icon.classList.add('auto-refresh-spinning');
        });
        
        // Perform silent refresh - if email not found, reload page to get new email
        fetch('/fetch-emails/' + emailId, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Current messages:', data.count, 'New count:', data.count);
            if (data.status === 'success' && data.count > 0) {
                // Silently reload page to display new emails
                location.reload();
            } else if (data.status === 'error' && data.message === 'Email not found') {
                // Email expired, reload to get new one
                location.reload();
            }
        })
        .catch(error => {
            console.error('Auto-refresh error:', error);
            // On error, reload page to reset state
            location.reload();
        })
        .finally(() => {
            // Remove auto-refresh animation
            setTimeout(() => {
                refreshIcons.forEach(icon => {
                    icon.classList.remove('auto-refresh-spinning');
                });
            }, 2000);
        });
    }, 15000); // 15 seconds for more frequent checking
    {% endif %}
}

// Change email function
function changeEmail() {
    if (confirm('Generate a new temporary email? This will delete the current one and all its messages.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/generate-email';
        document.body.appendChild(form);
        form.submit();
    }
}



// Delete email function
function deleteEmail(emailId) {
    if (confirm('Delete this temporary email and all its messages?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/delete-email/' + emailId;
        document.body.appendChild(form);
        form.submit();
    }
}

// Copy to clipboard functionality
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const text = this.getAttribute('data-text');
            navigator.clipboard.writeText(text).then(() => {
                const originalContent = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check"></i> <span>Copied!</span>';
                setTimeout(() => {
                    this.innerHTML = originalContent;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard');
            });
        });
    });
    
    // Toggle email content visibility
    document.querySelectorAll('.toggle-email').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const messageId = this.getAttribute('data-message-id');
            const content = document.getElementById('email-content-' + messageId);
            const icon = this.querySelector('i');
            
            if (content) {
                // Simple toggle - if display is none or has hidden class, show it
                if (content.style.display === 'none' || content.classList.contains('hidden')) {
                    // Show the content
                    content.style.display = 'block';
                    content.classList.remove('hidden');
                    if (icon) {
                        icon.className = 'fas fa-eye-slash';
                    }
                    console.log('Showing email content');
                    
                    // Process email content for better formatting and links
                    setTimeout(() => {
                        const emailContentDiv = content.querySelector('.email-content');
                        if (emailContentDiv) {
                            processEmailContentInline(emailContentDiv);
                        }
                        
                        // Make all links in this email content open in new tabs
                        content.querySelectorAll('a').forEach(link => {
                            link.setAttribute('target', '_blank');
                            link.setAttribute('rel', 'noopener noreferrer');
                        });
                    }, 50);
                } else {
                    // Hide the content
                    content.style.display = 'none';
                    content.classList.add('hidden');
                    if (icon) {
                        icon.className = 'fas fa-eye';
                    }
                    console.log('Hiding email content');
                }
            } else {
                console.error('Content element not found for message ID:', messageId);
            }
        });
    });
});

// Start auto-refresh functionality
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
});

// Process email content for better formatting and convert links to buttons
function processEmailContentInline(emailBody) {
    if (!emailBody) return;
    
    let content = emailBody.textContent || emailBody.innerText || '';
    
    // Clean up JSON formatting characters
    content = content.replace(/[{}"\[\]]/g, '');
    content = content.replace(/,\s*/g, ', ');
    content = content.replace(/:\s*/g, ': ');
    
    // Convert URLs to buttons with dynamic names
    content = content.replace(
        /(https?:\/\/[^\s]+)/g,
        function(match, url) {
            let buttonText = 'Visit Link';
            
            // Extract domain for button text
            try {
                const urlObj = new URL(url);
                const domain = urlObj.hostname.replace('www.', '');
                
                // Set specific button text based on common domains
                if (domain.includes('verify') || url.includes('verify')) {
                    buttonText = 'Verify Account';
                } else if (domain.includes('confirm') || url.includes('confirm')) {
                    buttonText = 'Confirm Email';
                } else if (domain.includes('github')) {
                    buttonText = 'Go to GitHub';
                } else if (domain.includes('google')) {
                    buttonText = 'Go to Google';
                } else if (domain.includes('amazon')) {
                    buttonText = 'Go to Amazon';
                } else if (domain.includes('facebook')) {
                    buttonText = 'Go to Facebook';
                } else if (domain.includes('twitter') || domain.includes('x.com')) {
                    buttonText = 'Go to Twitter/X';
                } else if (domain.includes('lovable')) {
                    buttonText = 'Go to Lovable';
                } else {
                    buttonText = `Go to ${domain.charAt(0).toUpperCase() + domain.slice(1)}`;
                }
            } catch (e) {
                // If URL parsing fails, keep default text
                buttonText = 'Visit Link';
            }
            
            return `<a href="${url}" target="_blank" rel="noopener noreferrer" 
                   class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 my-2 mr-2">
                   <i class="fas fa-external-link-alt mr-1"></i> ${buttonText}
                   </a>`;
        }
    );
    
    // Highlight verification codes (4-8 digit numbers)
    content = content.replace(
        /\b(\d{4,8})\b/g, 
        '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-mono font-bold">$1</span>'
    );
    
    // Update email body with processed content
    emailBody.innerHTML = content;
}

// Function to make all links in email content open in new tabs
function makeLinksOpenInNewTab() {
    document.querySelectorAll('.email-content a').forEach(link => {
        link.setAttribute('target', '_blank');
        link.setAttribute('rel', 'noopener noreferrer');
    });
}

// Run the function when page loads and whenever email content is shown
document.addEventListener('DOMContentLoaded', function() {
    makeLinksOpenInNewTab();
});

// Also run when email content is toggled (in case content is dynamically shown)
const originalToggle = document.querySelectorAll('.toggle-email');
originalToggle.forEach(button => {
    button.addEventListener('click', function() {
        // Small delay to let content appear before processing links
        setTimeout(makeLinksOpenInNewTab, 100);
    });
});
</script>

<style>
/* Gmail-style email content styling */
.gmail-email-content {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    font-size: 14px;
    line-height: 1.6;
    color: #202124;
}

.gmail-email-content h1,
.gmail-email-content h2,
.gmail-email-content h3,
.gmail-email-content h4,
.gmail-email-content h5,
.gmail-email-content h6 {
    margin: 0 0 12px 0;
    font-weight: 600;
    color: #1a73e8;
}

.gmail-email-content p {
    margin: 0 0 16px 0;
    color: #3c4043;
}

.gmail-email-content a {
    color: #1a73e8;
    text-decoration: none;
    border-radius: 4px;
    padding: 8px 16px;
    background-color: #1a73e8;
    color: white !important;
    display: inline-block;
    margin: 8px 0;
    font-weight: 500;
    transition: all 0.2s ease;
}

.gmail-email-content a:hover {
    background-color: #1557b0;
    box-shadow: 0 2px 4px rgba(26, 115, 232, 0.3);
}

.gmail-email-content .text-content {
    white-space: pre-wrap;
}

.gmail-email-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 16px 0;
}

.gmail-email-content th,
.gmail-email-content td {
    border: 1px solid #dadce0;
    padding: 8px 12px;
    text-align: left;
}

.gmail-email-content th {
    background-color: #f8f9fa;
    font-weight: 500;
}

.gmail-email-content blockquote {
    border-left: 4px solid #1a73e8;
    margin: 16px 0;
    padding: 8px 16px;
    background-color: #f8f9fa;
    color: #5f6368;
    font-style: italic;
}

.gmail-email-content ul,
.gmail-email-content ol {
    padding-left: 20px;
    margin: 12px 0;
}

.gmail-email-content li {
    margin: 4px 0;
}

.gmail-email-content code {
    background-color: #f1f3f4;
    border-radius: 4px;
    padding: 2px 6px;
    font-family: 'Roboto Mono', monospace;
    font-size: 13px;
}

/* Professional verification codes highlighting */
.gmail-email-content .verification-code {
    background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-family: 'Roboto Mono', monospace;
    font-weight: 600;
    letter-spacing: 2px;
    display: inline-block;
    margin: 8px 4px;
    box-shadow: 0 2px 8px rgba(26, 115, 232, 0.2);
}

/* Professional buttons from links */
.gmail-email-content .action-button {
    background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    display: inline-block;
    margin: 16px 8px;
    box-shadow: 0 4px 12px rgba(52, 211, 153, 0.3);
    transition: all 0.3s ease;
}

.gmail-email-content .action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(52, 211, 153, 0.4);
}
</style>

{% endblock %}
