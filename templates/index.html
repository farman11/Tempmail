{% extends "base.html" %}

{% block content %}
<!-- Dark Header Section with Email Display -->
<div class="bg-gray-800 text-white py-16">
    <div class="max-w-4xl mx-auto text-center px-6">
        <h1 class="text-3xl font-bold mb-8">
            Your Temporary Email Address
        </h1>
        
        {% if active_emails and active_emails|length > 0 %}
        <!-- Display existing email -->
        <div class="bg-gray-700 rounded-lg p-6 mb-6 max-w-2xl mx-auto">
            <div class="flex items-center justify-center space-x-4">
                <code class="text-xl font-mono text-white">{{ active_emails[0].email_address }}</code>
                <button class="bg-gray-600 hover:bg-gray-500 text-white p-2 rounded copy-btn" 
                        data-text="{{ active_emails[0].email_address }}" title="Copy">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="bg-green-600 hover:bg-green-500 text-white p-2 rounded" title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        {% else %}
        <!-- Generate new email -->
        <div class="bg-gray-700 rounded-lg p-6 mb-6 max-w-2xl mx-auto">
            <form method="POST" action="{{ url_for('generate_email') }}" class="text-center">
                <p class="text-gray-300 mb-4">Click to generate your temporary email address</p>
                <button type="submit" class="bg-green-600 hover:bg-green-500 text-white font-semibold py-3 px-8 rounded-lg btn-transition">
                    Generate Email Address
                </button>
            </form>
        </div>
        {% endif %}
        
        <p class="text-gray-300 text-sm max-w-2xl mx-auto">
            Forget about spam, advertising mailings, hacking and attacking robots. Keep your 
            real mailbox clean and secure. Temp Mail provides temporary, secure, anonymous, 
            free, disposable email address.
        </p>
    </div>
</div>

<!-- Action Buttons Section -->
{% if active_emails and active_emails|length > 0 %}
<div class="bg-white border-b border-gray-200 py-4">
    <div class="max-w-4xl mx-auto px-6">
        <div class="flex justify-center space-x-6">
            <button class="flex items-center space-x-2 text-gray-700 hover:text-black copy-btn" 
                    data-text="{{ active_emails[0].email_address }}">
                <i class="fas fa-copy"></i>
                <span>Copy</span>
            </button>
            <button class="flex items-center space-x-2 text-gray-700 hover:text-black" onclick="refreshEmails()">
                <i class="fas fa-sync-alt refresh-icon"></i>
                <span>Refresh</span>
            </button>
            <button class="flex items-center space-x-2 text-gray-700 hover:text-black" onclick="changeEmail()">
                <i class="fas fa-edit"></i>
                <span>Change</span>
            </button>
            <button onclick="deleteEmail('{{ active_emails[0].id }}')" 
                    class="flex items-center space-x-2 text-gray-700 hover:text-red-600">
                <i class="fas fa-times"></i>
                <span>Delete</span>
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Main Content Area with Sidebar -->
<div class="flex max-w-7xl mx-auto">
    <!-- Main Content -->
    <div class="flex-1 bg-white">
        <!-- Email Inbox Section -->
        {% if active_emails and active_emails|length > 0 %}
        <div class="p-6">
            <!-- Inbox Header -->
            <div class="bg-gray-800 text-white px-4 py-3 flex justify-between items-center">
                <span class="font-semibold">SENDER</span>
                <span class="font-semibold">SUBJECT</span>
                <span class="font-semibold">VIEW</span>
            </div>
            
            <!-- Email List -->
            {% if active_emails[0].messages and active_emails[0].messages|length > 0 %}
                {% for message in active_emails[0].messages %}
                <div class="border-b border-gray-200 px-4 py-4 hover:bg-gray-50">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">
                                {% if message.sender_name and message.sender_name != message.sender_email %}
                                    {{ message.sender_name }}
                                {% else %}
                                    {{ message.sender_email.split('@')[0] }}
                                {% endif %}
                            </div>
                            <div class="text-sm text-gray-500">{{ message.sender_email }}</div>
                        </div>
                        <div class="flex-1 px-4">
                            <div class="font-medium text-gray-900">{{ message.subject }}</div>
                        </div>
                        <div>
                            <button class="text-blue-600 hover:text-blue-800 toggle-email" data-message-id="{{ loop.index }}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Email Content (Initially Hidden) -->
                    <div id="email-content-{{ loop.index }}" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border">
                        <div class="mb-4 border-b border-gray-300 pb-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                <div><strong>From:</strong> {{ message.sender_name or message.sender_email.split('@')[0] }} &lt;{{ message.sender_email }}&gt;</div>
                                <div><strong>To:</strong> {{ active_emails[0].email_address }}</div>
                                <div><strong>Subject:</strong> {{ message.subject }}</div>
                                <div><strong>Date:</strong> {{ message.received_at.strftime('%Y-%m-%d %H:%M') if message.received_at else 'Unknown' }}</div>
                            </div>
                        </div>
                        <div class="email-body bg-white p-4 rounded border">
                            {% if message.html_content %}
                                <div class="prose max-w-none">{{ message.html_content|safe }}</div>
                            {% elif message.text_content %}
                                <div class="whitespace-pre-wrap font-mono text-sm">{{ message.text_content }}</div>
                            {% else %}
                                <div class="text-gray-500 italic">No message content available</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="text-center py-12 text-gray-500">
                <i class="fas fa-inbox text-4xl mb-4"></i>
                <p>No emails received yet</p>
                <p class="text-sm">Emails will appear here automatically</p>
                <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Check for New Emails
                </button>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- What is Disposable Temporary Email Section -->
        <div class="p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">What is Disposable Temporary E-mail?</h2>
            <div class="text-gray-700 space-y-4">
                <p>
                    Disposable email - is a free email service that allows to receive email at a temporary address 
                    that self-destructed after a certain time elapses. It is also known by names like: tempmail, 
                    10minutemail, throwaway email, fake-mail or trash-mail. Many forums, Wi-Fi owners, websites and 
                    blogs ask visitors to register before they can view content, post comments or download something. 
                    Temp-Mail - is most advanced throwaway email service that helps you avoid spam and stay safe.
                </p>
            </div>
            
            <!-- Ad Banner -->
            <div class="my-8">
                <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg p-4 text-white text-center">
                    <small class="block mb-2 opacity-75">Advertisement</small>
                    <div class="text-sm">
                        <i class="fas fa-ad text-2xl mb-2"></i>
                        <p>Make it with Creative Cloud. Apps for photography, design, video, and web from $59.99/mo</p>
                    </div>
                </div>
            </div>
            
            <h3 class="text-xl font-bold text-gray-900 mb-4">Popular Articles</h3>
        </div>
    </div>
    
    <!-- Right Sidebar -->
    <div class="w-80 bg-white border-l border-gray-200">
        <!-- Advertisement Space -->
        <div class="p-4">
            <div class="bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg p-6 text-white text-center min-h-80">
                <small class="block mb-2 opacity-75">Advertisement</small>
                <div class="text-center">
                    <i class="fas fa-ad text-3xl mb-3"></i>
                    <h3 class="text-lg font-bold mb-2">Make it with Creative Cloud</h3>
                    <p class="text-sm mb-4">Apps for photography, design, video, and web from $59.99/mo</p>
                    <button class="bg-white text-purple-600 px-4 py-2 rounded font-semibold">
                        Join now
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Real-time email refresh functionality
function refreshEmails() {
    const refreshIcon = document.querySelector('.refresh-icon');
    const originalClass = refreshIcon.className;
    
    // Add spinning animation
    refreshIcon.className = 'fas fa-sync-alt fa-spin';
    
    // Call the fetch-emails endpoint
    fetch('/fetch-emails', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (data.new_messages > 0) {
                // Show success message and reload page to display new emails
                alert(`Found ${data.new_messages} new message(s)! Refreshing...`);
                location.reload();
            } else {
                // Show no new messages
                alert('No new messages found');
            }
        } else {
            alert('Error checking for emails: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error checking for emails');
    })
    .finally(() => {
        // Reset icon
        refreshIcon.className = originalClass;
    });
}

// Change email function
function changeEmail() {
    if (confirm('Generate a new temporary email? This will delete the current one and all its messages.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/generate-email';
        document.body.appendChild(form);
        form.submit();
    }
}

// Delete email function
function deleteEmail(emailId) {
    if (confirm('Delete this temporary email and all its messages?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/delete-email/' + emailId;
        document.body.appendChild(form);
        form.submit();
    }
}

// Copy to clipboard functionality
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const text = this.getAttribute('data-text');
            navigator.clipboard.writeText(text).then(() => {
                const originalContent = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check"></i> <span>Copied!</span>';
                setTimeout(() => {
                    this.innerHTML = originalContent;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard');
            });
        });
    });
    
    // Toggle email content visibility
    document.querySelectorAll('.toggle-email').forEach(button => {
        button.addEventListener('click', function() {
            const messageId = this.getAttribute('data-message-id');
            const content = document.getElementById('email-content-' + messageId);
            const icon = this.querySelector('i');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.className = 'fas fa-eye-slash';
            } else {
                content.classList.add('hidden');
                icon.className = 'fas fa-eye';
            }
        });
    });
});

// Auto-refresh every 30 seconds
setInterval(function() {
    refreshEmails();
}, 30000);
</script>
{% endblock %}
